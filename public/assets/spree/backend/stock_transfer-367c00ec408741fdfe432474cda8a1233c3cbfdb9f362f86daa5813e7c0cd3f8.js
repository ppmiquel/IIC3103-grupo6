(function(){var t=function(t,r){function e(){this.constructor=t}for(var i in r)n.call(r,i)&&(t[i]=r[i]);return e.prototype=r.prototype,t.prototype=new e,t.__super__=r.prototype,t},n={}.hasOwnProperty;$(function(){var n,r,e,i,o,a,s,c;return i=function(){function t(t){this.variant=t,this.id=this.variant.id,this.name=this.variant.name+" - "+this.variant.sku,this.quantity=0}return t.prototype.add=function(t){return this.quantity+=t},t}(),e=function(n){function r(t){this.stock_item=t,r.__super__.constructor.call(this,this.stock_item.variant),this.count_on_hand=this.stock_item.count_on_hand,this.name=this.variant.name+" - "+this.variant.sku+" ("+this.count_on_hand+")"}return t(r,n),r.prototype.add=function(t){return this.quantity+=t,this.quantity>this.count_on_hand?this.quantity=this.count_on_hand:void 0},r}(i),r=function(){function t(){this.source=$("#transfer_source_location_id"),this.destination=$("#transfer_destination_location_id"),this.source.change(function(t){return function(){return t.populate_destination()}}(this)),$("#transfer_receive_stock").change(function(t){return function(n){return t.receive_stock_change(n)}}(this)),$.getJSON(Spree.url(Spree.routes.stock_locations_api)+"?token="+Spree.api_key,function(t){return function(n){var r;return t.locations=function(){var t,e,i,o;for(i=n.stock_locations,o=[],t=0,e=i.length;e>t;t++)r=i[t],o.push(r);return o}(),t.locations.length<2&&t.force_receive_stock(),t.populate_source(),t.populate_destination()}}(this))}return t.prototype.force_receive_stock=function(){return $("#receive_stock_field").hide(),$("#transfer_receive_stock").prop("checked",!0),this.toggle_source_location(!0)},t.prototype.is_source_location_hidden=function(){return"hidden"===$("#transfer_source_location_id_field").css("visibility")},t.prototype.toggle_source_location=function(t){return null==t&&(t=!1),this.source.trigger("change"),this.is_source_location_hidden()&&!t?($("#transfer_source_location_id_field").css("visibility","visible"),$("#transfer_source_location_id_field").show()):($("#transfer_source_location_id_field").css("visibility","hidden"),$("#transfer_source_location_id_field").hide())},t.prototype.receive_stock_change=function(t){return this.toggle_source_location(t.target.checked),this.populate_destination(!t.target.checked)},t.prototype.populate_source=function(){return this.populate_select(this.source),this.source.trigger("change")},t.prototype.populate_destination=function(t){return null==t&&(t=!0),this.is_source_location_hidden()?this.populate_select(this.destination):this.populate_select(this.destination,parseInt(this.source.val()))},t.prototype.populate_select=function(t,n){var r,e,i,o;for(null==n&&(n=0),t.children("option").remove(),o=this.locations,r=0,e=o.length;e>r;r++)i=o[r],i.id!==n&&t.append($("<option></option>").text(i.name).attr("value",i.id));return t.select2()},t}(),o=function(){function t(){$("#transfer_source_location_id").change(function(t){return function(){return t.refresh_variants()}}(this))}return t.prototype.receiving_stock=function(){return $("#transfer_receive_stock:checked").length>0},t.prototype.refresh_variants=function(){return this.receiving_stock()?this._search_transfer_variants():this._search_transfer_stock_items()},t.prototype._search_transfer_variants=function(){return this.build_select(Spree.url(Spree.routes.variants_api),"product_name_or_sku_cont")},t.prototype._search_transfer_stock_items=function(){var t;return t=$("#transfer_source_location_id").val(),this.build_select(Spree.url(Spree.routes.stock_locations_api+("/"+t+"/stock_items")),"variant_product_name_or_variant_sku_cont")},t.prototype.format_variant_result=function(t){return t.name+" - "+t.sku},t.prototype.build_select=function(t,n){return $("#transfer_variant").select2({minimumInputLength:3,ajax:{url:t,datatype:"json",data:function(t){var r;return r={},r[n]=t,{q:r,token:Spree.api_key}},results:function(t){var n;return n=t.variants||t.stock_items,null!=t.stock_items&&(n=_(n).map(function(t){return t.variant})),window.variants=n,{results:n}}},formatResult:this.format_variant_result,formatSelection:function(t){return t.options_text?t.name+(" ("+t.options_text+")")+(" - "+t.sku):t.name+(" - "+t.sku)}})},t}(),n=function(){function t(){this.variants=[],this.template=Handlebars.compile($("#transfer_variant_template").html()),$("#transfer_source_location_id").change(function(t){return function(){return t.clear_variants()}}(this)),$("button.transfer_add_variant").click(function(t){return function(n){return n.preventDefault(),null!=$("#transfer_variant").select2("data")?t.add_variant():alert("Please select a variant first")}}(this)),$("#transfer-variants-table").on("click",".transfer_remove_variant",function(t){return function(n){return n.preventDefault(),t.remove_variant($(n.target))}}(this)),$("button.transfer_transfer").click(function(t){return function(){return t.variants.length>0?void 0:(alert("no variants to transfer"),!1)}}(this))}return t.prototype.add_variant=function(){var t,n;return n=$("#transfer_variant").select2("data"),t=parseInt($("#transfer_variant_quantity").val()),n=this.find_or_add(n),n.add(t),this.render()},t.prototype.find_or_add=function(t){var n;return(n=_.find(this.variants,function(n){return n.id===t.id}))?n:(t=new i($.extend({},t)),this.variants.push(t),t)},t.prototype.remove_variant=function(t){var n,r;return r=parseInt(t.data("variantId")),this.variants=function(){var t,e,i,o;for(i=this.variants,o=[],t=0,e=i.length;e>t;t++)n=i[t],n.id!==r&&o.push(n);return o}.call(this),this.render()},t.prototype.clear_variants=function(){return this.variants=[],this.render()},t.prototype.contains=function(t){return _.contains(_.pluck(this.variants,"id"),t)},t.prototype.render=function(){var t;return 0===this.variants.length?($("#transfer-variants-table").hide(),$(".no-objects-found").show()):($("#transfer-variants-table").show(),$(".no-objects-found").hide(),t=this.template({variants:this.variants}),$("#transfer_variants_tbody").html(t))},t}(),$("#transfer_source_location_id").length>0?(s=new r,c=new o,a=new n):void 0})}).call(this);